<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM 푸시 테스트</title>
    <script type="module">
        // API 기본 URL 설정
        const PORT = 5000;
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? `http://localhost:${PORT}` 
            : '/.netlify/functions';

        // Firebase SDK import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-messaging.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDrpO0vDYn8nldMbV37mI49Yemk2VGE3X8",
            authDomain: "web-push-fe250.firebaseapp.com",
            projectId: "web-push-fe250",
            storageBucket: "web-push-fe250.firebasestorage.app",
            messagingSenderId: "475730596102",
            appId: "1:475730596102:web:954947b2d9be8aa5fc4e87"
        };

        // Firebase 전역 변수
        let app;
        let messaging;

        // 페이지 로드시 실행할 초기화 함수
        async function initializeApplication() {
            console.log('앱 초기화 시작...');
            try {
                // Firebase 초기화
                app = initializeApp(firebaseConfig);
                messaging = getMessaging(app);
                console.log('Firebase 초기화 완료');

                // 세션 초기화
                const sessionId = sessionStorage.getItem('sessionId') || `session_${Date.now()}`;
                const userId = localStorage.getItem('userId');

                if (!userId) {
                    // 새 세션 등록
                    const response = await fetch(`${API_BASE_URL}/init-session`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ sessionId })
                    });

                    if (!response.ok) {
                        throw new Error('세션 초기화 실패');
                    }

                    const data = await response.json();
                    localStorage.setItem('userId', data.userId);
                    sessionStorage.setItem('sessionId', sessionId);
                    console.log('새 세션 등록됨:', data.userId);
                }

                // 사용자 목록 업데이트
                await updateUserList();

                // 알림 권한 요청
                await requestNotificationPermission();

                // 주기적 업데이트 설정
                setInterval(updateUserList, 10000);
                console.log('초기화 완료');

            } catch (err) {
                console.error('앱 초기화 실패:', err);
            }
        }

        // 페이지 로드시 초기화 실행
        console.log('페이지 로드됨, 초기화 시작');
        initializeApplication();

        // 알림 권한 요청
        async function requestNotificationPermission() {
            try {
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    console.log('알림 권한이 거부됨');
                    return;
                }

                const currentToken = await getToken(messaging);
                if (!currentToken) {
                    console.error('토큰을 가져올 수 없습니다');
                    return;
                }

                // 세션 정보 포함하여 전송
                const existingUserId = localStorage.getItem('userId');
                const sessionId = sessionStorage.getItem('sessionId');
                
                const response = await fetch(`${API_BASE_URL}/register-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        token: currentToken,
                        existingUserId,
                        sessionId
                    })
                });

                if (!response.ok) {
                    throw new Error('토큰 등록 실패');
                }

                const data = await response.json();
                localStorage.setItem('userId', data.userId);
                localStorage.setItem('fcmToken', currentToken);
                
                await updateUserList();
            } catch (error) {
                console.error('알림 설정 실패:', error);
            }
        }

        // 사용자 목록 업데이트
        async function updateUserList() {
            try {
                const response = await fetch(`${API_BASE_URL}/get-tokens`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const users = await response.json();
                if (!Array.isArray(users)) {
                    throw new Error('Invalid response format');
                }
                
                const select = document.getElementById('select');
                select.innerHTML = '<option value="">선택</option>';
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.id;
                    if (user.id === localStorage.getItem('userId')) {
                        option.textContent += ' (나)';
                    }
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('사용자 목록 조회 실패:', err);
            }
        }

        // 푸시 메시지 전송
        document.getElementById('btn').addEventListener('click', async () => {
            const select = document.getElementById('select');
            const userId = select.value;
            
            if (!userId) {
                alert('사용자를 선택해주세요.');
                return;
            }
            
            console.log('푸시 메시지 전송 중...', userId, '에게');
            try {
                const response = await fetch(`${API_BASE_URL}/send-push`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId })
                });
                const result = await response.json();
                console.log('푸시 전송 결과:', result);
                alert('푸시 메시지가 전송되었습니다.');
            } catch (err) {
                console.error('푸시 전송 실패:', err);
                alert('푸시 전송에 실패했습니다.');
            }
        });

        // 포그라운드 메시지 수신
        onMessage(messaging, (payload) => {
            console.log('포그라운드 메시지 수신:', payload);
            new Notification(payload.notification.title, {
                body: payload.notification.body
            });
        });
    </script>
</head>
<body>
    <h1>FCM 푸시 테스트</h1>

    <select id="select">
        <option value="">선택</option>
    </select>

    <button id="btn">전송</button>
</body>
</html>